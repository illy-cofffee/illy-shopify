<style>
    .video-carousel-section {
        padding: 40px 0;
    }

    .video-wrapper {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0;
    }

    .video-wrapper iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .video-carousel__item {
        padding: 0 10px;
    }

    .video-carousel__title {
        margin-top: 10px;
        text-align: center;
        font-weight: bold;
    }

    /* Slick carousel styles */
    .slick-prev,
    .slick-next {
        z-index: 1;
    }

    .slick-prev {
        left: 10px;
    }

    .slick-next {
        right: 10px;
    }
</style>

<div class="page-width">
  {% if section.settings.title != blank %}
    <div class="section-header text-center">
      <h2>{{ section.settings.title }}</h2>
    </div>
  {% endif %}

  {% assign videos = blank %}
  
  {% if section.settings.video_source == 'metafield' %}
    {% assign metafield_value = product.metafields[section.settings.metafield_namespace][section.settings.metafield_key] %}
    {% if metafield_value %}
      {% assign videos = metafield_value %}
    {% endif %}
  {% elsif section.settings.video_source == 'metaobject' %}
    {% assign metaobject_handle = section.settings.metaobject_handle %}
    {% if product.metaobjects[metaobject_handle] %}
      {% assign video_metaobjects = product.metaobjects[metaobject_handle] %}
      {% if video_metaobjects.type == 'list.product_video' %}
        {% assign videos = video_metaobjects.value %}
      {% endif %}
    {% endif %}
  {% endif %}

  {% if videos != blank %}
    <div class="video-carousel-wrapper">
      <div class="video-carousel js-video-carousel" 
           data-slides-to-show="{{ section.settings.slides_to_show }}"
           data-autoplay="{{ section.settings.autoplay }}"
           data-autoplay-speed="{{ section.settings.autoplay_speed | times: 1000 }}">
        
        {% if section.settings.video_source == 'metafield' %}
          {% if videos.type == 'json' %}
            {% assign video_list = videos.value | parse_json %}
            {% for video in video_list %}
              <div class="video-carousel__item">
                <div class="video-wrapper">
                  {% if video.platform == 'youtube' %}
                    <iframe src="https://www.youtube.com/embed/{{ video.id }}?rel=0&showinfo=0" frameborder="0" allowfullscreen></iframe>
                  {% elsif video.platform == 'vimeo' %}
                    <iframe src="https://player.vimeo.com/video/{{ video.id }}" frameborder="0" allowfullscreen></iframe>
                  {% endif %}
                </div>
                {% if video.title %}
                  <div class="video-carousel__title">{{ video.title }}</div>                
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}
        {% elsif section.settings.video_source == 'metaobject' %}
          {% for video_ref in videos %}
            {% assign video = video_ref.value %}
            <div class="video-carousel__item">
              <div class="video-wrapper">
                {% if video.platform.value == 'youtube' %}
                  <iframe src="https://www.youtube.com/embed/{{ video.video_id.value }}?rel=0&showinfo=0" frameborder="0" allowfullscreen></iframe>
                {% elsif video.platform.value == 'vimeo' %}
                  <iframe src="https://player.vimeo.com/video/{{ video.video_id.value }}" frameborder="0" allowfullscreen></iframe>
                {% endif %}
              </div>
              {% if video.title.value != blank %}
                <div class="video-carousel__title">{{ video.title.value }}</div>
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var carousel = $('.js-video-carousel');
        
        carousel.slick({
          slidesToShow: carousel.data('slides-to-show'),
          slidesToScroll: 1,
          dots: true,
          arrows: true,
          autoplay: carousel.data('autoplay'),
          autoplaySpeed: carousel.data('autoplay-speed'),
          responsive: [
            {
              breakpoint: 768,
              settings: {
                slidesToShow: 1
              }
            }
          ]
        });
        
        // Stop videos when sliding
        carousel.on('beforeChange', function(event, slick, currentSlide, nextSlide) {
          var currentSlideElement = $(slick.$slides.get(currentSlide));
          var iframe = currentSlideElement.find('iframe');
          
          if (iframe.length) {
            var iframeSrc = iframe.attr('src');
            iframe.attr('src', iframeSrc);
          }
        });
      });
    </script>
  {% else %}
    <div class="placeholder-noblocks">
      No videos found. Please add videos to the product metafields or metaobjects.
    </div>
  {% endif %}
</div>


{% schema %}
{
  "name": "Video Carousel",
  "tag": "section",
  "class": "video-carousel-section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Product Videos"
    },
    {
      "type": "select",
      "id": "video_source",
      "label": "Video Source",
      "options": [
        {
          "value": "metafield",
          "label": "Metafields"
        },
        {
          "value": "metaobject",
          "label": "Metaobjects"
        }
      ],
      "default": "metafield"
    },
    {
      "type": "text",
      "id": "metafield_namespace",
      "label": "Metafield Namespace",
      "default": "product",
      "info": "Only used when Video Source is set to Metafields"
    },
    {
      "type": "text",
      "id": "metafield_key",
      "label": "Metafield Key",
      "default": "videos",
      "info": "Only used when Video Source is set to Metafields. Use JSON format for multiple videos"
    },
    {
      "type": "text",
      "id": "metaobject_handle",
      "label": "Metaobject Handle",
      "default": "product_videos",
      "info": "Only used when Video Source is set to Metaobjects"
    },
    {
      "type": "range",
      "id": "slides_to_show",
      "min": 1,
      "max": 3,
      "step": 1,
      "label": "Videos to show",
      "default": 1
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay carousel",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "label": "Autoplay speed (in seconds)",
      "default": 5
    }
  ],
  "presets": [
    {
      "name": "Video Carousel",
      "category": "Video"
    }
  ]
}
{% endschema %}